name: Deploy Next.js Service (Reusable)

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
        description: 'Service name (e.g., joss-fe)'
      environment:
        required: true
        type: string
        description: 'Target environment (dev or prod)'
      node-version:
        type: string
        default: '20'
      memory:
        type: string
        default: '512Mi'
      cpu:
        type: string
        default: '1'
      min-instances:
        type: number
        default: 0
      max-instances:
        type: number
        default: 10
      timeout:
        type: string
        default: '300s'
      concurrency-limit:
        type: number
        default: 80
      run-lint:
        type: boolean
        default: true
      # Build-time environment variables (NEXT_PUBLIC_*) - baked into JS bundle
      next-public-keycloak-url:
        required: true
        type: string
        description: 'Keycloak URL for client-side auth (e.g., https://sso-joss.lmd.co.id/)'
      next-public-keycloak-realm:
        type: string
        default: 'lmd'
      next-public-keycloak-client-id:
        type: string
        default: 'web-client'
      next-public-api-url:
        required: true
        type: string
        description: 'API URL for client-side requests (e.g., https://api-joss.lmd.co.id/api)'
      # Runtime environment variables - read by server-side code
      nextauth-url:
        required: true
        type: string
        description: 'NextAuth URL (e.g., https://joss.lmd.co.id)'
      keycloak-issuer:
        required: true
        type: string
        description: 'Keycloak issuer URL (e.g., https://sso-joss.lmd.co.id/realms/lmd)'
      keycloak-client-id:
        type: string
        default: 'web-client-next-auth'
        description: 'Keycloak client ID for NextAuth'
      api-url:
        required: true
        type: string
        description: 'Backend API URL for server-side requests'

jobs:
  lint:
    name: Lint
    if: ${{ inputs.run-lint }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment == 'prod' && 'production' || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

  build-and-push:
    name: Build & Push Image
    needs: [lint]
    if: always() && (needs.lint.result == 'success' || needs.lint.result == 'skipped')
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment == 'prod' && 'production' || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment-specific variables
        id: env
        run: |
          if [ "${{ inputs.environment }}" == "prod" ]; then
            echo "gcp_project=${{ vars.GCP_PROJECT_ID_PROD }}" >> $GITHUB_OUTPUT
            echo "region=${{ vars.GCP_REGION_PROD }}" >> $GITHUB_OUTPUT
            echo "registry=${{ vars.ARTIFACT_REGISTRY_URL_PROD }}" >> $GITHUB_OUTPUT
          else
            echo "gcp_project=${{ vars.GCP_PROJECT_ID_DEV }}" >> $GITHUB_OUTPUT
            echo "region=${{ vars.GCP_REGION_DEV }}" >> $GITHUB_OUTPUT
            echo "registry=${{ vars.ARTIFACT_REGISTRY_URL_DEV }}" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ inputs.environment == 'prod' && secrets.WORKLOAD_IDENTITY_PROVIDER_PROD || secrets.WORKLOAD_IDENTITY_PROVIDER_DEV }}
          service_account: ${{ inputs.environment == 'prod' && secrets.SERVICE_ACCOUNT_EMAIL_PROD || secrets.SERVICE_ACCOUNT_EMAIL_DEV }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ steps.env.outputs.region }}-docker.pkg.dev

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          build-args: |
            NEXT_PUBLIC_KEYCLOAK_URL=${{ inputs.next-public-keycloak-url }}
            NEXT_PUBLIC_KEYCLOAK_REALM=${{ inputs.next-public-keycloak-realm }}
            NEXT_PUBLIC_KEYCLOAK_CLIENT_ID=${{ inputs.next-public-keycloak-client-id }}
            NEXT_PUBLIC_API_URL=${{ inputs.next-public-api-url }}
          tags: |
            ${{ steps.env.outputs.registry }}/${{ inputs.service-name }}:${{ github.sha }}
            ${{ steps.env.outputs.registry }}/${{ inputs.service-name }}:${{ inputs.environment }}-latest
          cache-from: type=registry,ref=${{ steps.env.outputs.registry }}/${{ inputs.service-name }}:buildcache
          cache-to: type=registry,ref=${{ steps.env.outputs.registry }}/${{ inputs.service-name }}:buildcache,mode=max

  deploy:
    name: Deploy to Cloud Run (${{ inputs.environment }})
    needs: [build-and-push]
    if: always() && needs.build-and-push.result == 'success'
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment == 'prod' && 'production' || 'dev' }}

    steps:
      - name: Set environment-specific variables
        id: env
        run: |
          ENV="${{ inputs.environment }}"
          
          if [ "$ENV" == "prod" ]; then
            echo "gcp_project=${{ vars.GCP_PROJECT_ID_PROD }}" >> $GITHUB_OUTPUT
            echo "region=${{ vars.GCP_REGION_PROD }}" >> $GITHUB_OUTPUT
            echo "registry=${{ vars.ARTIFACT_REGISTRY_URL_PROD }}" >> $GITHUB_OUTPUT
            echo "min_instances=1" >> $GITHUB_OUTPUT
            echo "env_suffix=production" >> $GITHUB_OUTPUT
          else
            echo "gcp_project=${{ vars.GCP_PROJECT_ID_DEV }}" >> $GITHUB_OUTPUT
            echo "region=${{ vars.GCP_REGION_DEV }}" >> $GITHUB_OUTPUT
            echo "registry=${{ vars.ARTIFACT_REGISTRY_URL_DEV }}" >> $GITHUB_OUTPUT
            echo "min_instances=${{ inputs.min-instances }}" >> $GITHUB_OUTPUT
            echo "env_suffix=dev" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ inputs.environment == 'prod' && secrets.WORKLOAD_IDENTITY_PROVIDER_PROD || secrets.WORKLOAD_IDENTITY_PROVIDER_DEV }}
          service_account: ${{ inputs.environment == 'prod' && secrets.SERVICE_ACCOUNT_EMAIL_PROD || secrets.SERVICE_ACCOUNT_EMAIL_DEV }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        run: |
          # Service account: {service-name}-{env}@{project}.iam.gserviceaccount.com
          SERVICE_ACCOUNT="${{ inputs.service-name }}-${{ steps.env.outputs.env_suffix }}@${{ steps.env.outputs.gcp_project }}.iam.gserviceaccount.com"
          
          # Runtime environment variables
          ENV_VARS="NEXTAUTH_URL=${{ inputs.nextauth-url }}"
          ENV_VARS="${ENV_VARS},KEYCLOAK_ISSUER=${{ inputs.keycloak-issuer }}"
          ENV_VARS="${ENV_VARS},KEYCLOAK_CLIENT_ID=${{ inputs.keycloak-client-id }}"
          ENV_VARS="${ENV_VARS},API_URL=${{ inputs.api-url }}"
          
          # Secrets from GCP Secret Manager
          SECRETS_FLAG="NEXTAUTH_SECRET=nextauth-secret-${{ steps.env.outputs.env_suffix }}:latest"
          SECRETS_FLAG="${SECRETS_FLAG},KEYCLOAK_CLIENT_SECRET=keycloak-client-secret-${{ steps.env.outputs.env_suffix }}:latest"
          
          echo "==========================================="
          echo "Deploying ${{ inputs.service-name }}"
          echo "==========================================="
          echo "Environment:     ${{ inputs.environment }}"
          echo "Project:         ${{ steps.env.outputs.gcp_project }}"
          echo "Region:          ${{ steps.env.outputs.region }}"
          echo "Service Account: ${SERVICE_ACCOUNT}"
          echo "Image:           ${{ steps.env.outputs.registry }}/${{ inputs.service-name }}:${{ github.sha }}"
          echo "==========================================="
          
          gcloud run deploy ${{ inputs.service-name }} \
            --image ${{ steps.env.outputs.registry }}/${{ inputs.service-name }}:${{ github.sha }} \
            --region ${{ steps.env.outputs.region }} \
            --project ${{ steps.env.outputs.gcp_project }} \
            --platform managed \
            --service-account ${SERVICE_ACCOUNT} \
            --port 3000 \
            --cpu ${{ inputs.cpu }} \
            --memory ${{ inputs.memory }} \
            --min-instances ${{ steps.env.outputs.min_instances }} \
            --max-instances ${{ inputs.max-instances }} \
            --timeout ${{ inputs.timeout }} \
            --concurrency ${{ inputs.concurrency-limit }} \
            --allow-unauthenticated \
            --set-env-vars "${ENV_VARS}" \
            --set-secrets "${SECRETS_FLAG}"

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ inputs.service-name }} \
            --region ${{ steps.env.outputs.region }} \
            --project ${{ steps.env.outputs.gcp_project }} \
            --format='value(status.url)')
          
          REVISION=$(gcloud run services describe ${{ inputs.service-name }} \
            --region ${{ steps.env.outputs.region }} \
            --project ${{ steps.env.outputs.gcp_project }} \
            --format='value(status.latestReadyRevisionName)')
          
          echo ""
          echo "==========================================="
          echo "Deployment Successful"
          echo "==========================================="
          echo "Service:     ${{ inputs.service-name }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Revision:    ${REVISION}"
          echo "URL:         ${SERVICE_URL}"
          echo "==========================================="
