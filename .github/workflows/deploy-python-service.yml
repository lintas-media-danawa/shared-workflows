name: Deploy Python Service (Reusable)

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
        description: 'Service name (e.g., ai-service)'
      environment:
        required: true
        type: string
        description: 'Target environment (dev or prod)'
      python-version:
        type: string
        default: '3.11'
      memory:
        type: string
        default: '2Gi'
      cpu:
        type: string
        default: '2'
      min-instances:
        type: number
        default: 0
      max-instances:
        type: number
        default: 10
      db-user:
        required: true
        type: string
        description: 'Database username (e.g., ai_service)'
      db-secret-name:
        required: true
        type: string
        description: 'DB password secret base name without env suffix (e.g., db-ai-service-password)'
      additional-env-vars:
        type: string
        default: ''
        description: 'Additional env vars in format: KEY1=value1,KEY2=value2'
      additional-secrets:
        type: string
        default: ''
        description: 'Additional secrets in format: ENV_VAR=secret-name-{env}:version (use {env} as placeholder)'
      run-tests:
        type: boolean
        default: true
      timeout:
        type: string
        default: '300s'
      concurrency-limit:
        type: number
        default: 80
      test-command:
        type: string
        default: 'pytest'
        description: 'Command to run tests (e.g., pytest, pytest -v)'

jobs:
  test:
    name: Run Tests
    if: ${{ inputs.run-tests }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment == 'prod' && 'production' || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run tests
        run: ${{ inputs.test-command }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY_TEST || 'test-key' }}

  build-and-push:
    name: Build & Push Image
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment == 'prod' && 'production' || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment-specific variables
        id: env
        run: |
          if [ "${{ inputs.environment }}" == "prod" ]; then
            echo "gcp_project=${{ vars.GCP_PROJECT_ID_PROD }}" >> $GITHUB_OUTPUT
            echo "region=${{ vars.GCP_REGION_PROD }}" >> $GITHUB_OUTPUT
            echo "registry=${{ vars.ARTIFACT_REGISTRY_URL_PROD }}" >> $GITHUB_OUTPUT
            echo "env_suffix=prod" >> $GITHUB_OUTPUT
            echo "vpc_connector=${{ vars.VPC_CONNECTOR_PROD }}" >> $GITHUB_OUTPUT
            echo "cloudsql=${{ vars.CLOUDSQL_INSTANCE_PROD }}" >> $GITHUB_OUTPUT
            echo "db_name=${{ vars.DB_NAME_PROD }}" >> $GITHUB_OUTPUT
            echo "min_instances=${{ vars.MIN_INSTANCES_PROD || '1' }}" >> $GITHUB_OUTPUT
          else
            echo "gcp_project=${{ vars.GCP_PROJECT_ID_DEV }}" >> $GITHUB_OUTPUT
            echo "region=${{ vars.GCP_REGION_DEV }}" >> $GITHUB_OUTPUT
            echo "registry=${{ vars.ARTIFACT_REGISTRY_URL_DEV }}" >> $GITHUB_OUTPUT
            echo "env_suffix=dev" >> $GITHUB_OUTPUT
            echo "vpc_connector=${{ vars.VPC_CONNECTOR_DEV }}" >> $GITHUB_OUTPUT
            echo "cloudsql=${{ vars.CLOUDSQL_INSTANCE_DEV }}" >> $GITHUB_OUTPUT
            echo "db_name=${{ vars.DB_NAME_DEV }}" >> $GITHUB_OUTPUT
            echo "min_instances=${{ vars.MIN_INSTANCES_DEV || '0' }}" >> $GITHUB_OUTPUT
          fi

      - name: Debug - Check secrets availability
        run: |
          echo "Environment: ${{ inputs.environment }}"
          echo "WIF Provider DEV length: ${#WIF_DEV}"
          echo "WIF Provider PROD length: ${#WIF_PROD}"
          echo "SA Email DEV length: ${#SA_DEV}"
          echo "SA Email PROD length: ${#SA_PROD}"
          if [ -z "$WIF_DEV" ]; then
            echo "ERROR: WORKLOAD_IDENTITY_PROVIDER_DEV is empty!"
          fi
          if [ -z "$SA_DEV" ]; then
            echo "ERROR: SERVICE_ACCOUNT_EMAIL_DEV is empty!"
          fi
        env:
          WIF_DEV: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER_DEV }}
          WIF_PROD: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER_PROD }}
          SA_DEV: ${{ secrets.SERVICE_ACCOUNT_EMAIL_DEV }}
          SA_PROD: ${{ secrets.SERVICE_ACCOUNT_EMAIL_PROD }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ inputs.environment == 'prod' && secrets.WORKLOAD_IDENTITY_PROVIDER_PROD || secrets.WORKLOAD_IDENTITY_PROVIDER_DEV }}
          service_account: ${{ inputs.environment == 'prod' && secrets.SERVICE_ACCOUNT_EMAIL_PROD || secrets.SERVICE_ACCOUNT_EMAIL_DEV }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ steps.env.outputs.region }}-docker.pkg.dev

      - name: Build Docker image
        run: |
          docker build \
            -t ${{ steps.env.outputs.registry }}/${{ inputs.service-name }}:${{ github.sha }} \
            -t ${{ steps.env.outputs.registry }}/${{ inputs.service-name }}:latest \
            .

      - name: Push Docker image
        run: |
          docker push ${{ steps.env.outputs.registry }}/${{ inputs.service-name }}:${{ github.sha }}
          docker push ${{ steps.env.outputs.registry }}/${{ inputs.service-name }}:latest

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        run: |
          # Service account: {service-name}-{env}@{project}.iam.gserviceaccount.com
          SERVICE_ACCOUNT="${{ inputs.service-name }}-${{ steps.env.outputs.env_suffix }}@${{ steps.env.outputs.gcp_project }}.iam.gserviceaccount.com"
          
          # DB password secret: {db-secret-name}-{env}:latest
          DB_SECRET="${{ inputs.db-secret-name }}-${{ steps.env.outputs.env_suffix }}:latest"
          
          # Build secrets flag
          SECRETS_FLAG="DB_PASSWORD=${DB_SECRET}"
          if [ -n "${{ inputs.additional-secrets }}" ]; then
            # Replace {env} placeholder with actual environment suffix
            ADDITIONAL_SECRETS=$(echo "${{ inputs.additional-secrets }}" | sed "s/{env}/${{ steps.env.outputs.env_suffix }}/g")
            SECRETS_FLAG="${SECRETS_FLAG},${ADDITIONAL_SECRETS}"
          fi
          
          # Build env vars - use ^:^ delimiter to support commas in values
          ENV_VARS="GCP_PROJECT_ID=${{ steps.env.outputs.gcp_project }}"
          ENV_VARS="${ENV_VARS}^:^CLOUDSQL_CONNECTION=${{ steps.env.outputs.cloudsql }}"
          ENV_VARS="${ENV_VARS}^:^DB_NAME=${{ steps.env.outputs.db_name }}"
          ENV_VARS="${ENV_VARS}^:^DB_USER=${{ inputs.db-user }}"
          if [ -n "${{ inputs.additional-env-vars }}" ]; then
            # Replace commas with ^:^ delimiter and remove backslash escapes
            ADDITIONAL_ENV_VARS="${{ inputs.additional-env-vars }}"
            ADDITIONAL_ENV_VARS="${ADDITIONAL_ENV_VARS//\\,/,}"  # Remove backslash escapes
            ADDITIONAL_ENV_VARS="${ADDITIONAL_ENV_VARS//,/^:^}"   # Replace , with ^:^
            ENV_VARS="${ENV_VARS}^:^${ADDITIONAL_ENV_VARS}"
          fi
          
          echo "==========================================="
          echo "Deploying ${{ inputs.service-name }}"
          echo "==========================================="
          echo "Environment:     ${{ inputs.environment }}"
          echo "Project:         ${{ steps.env.outputs.gcp_project }}"
          echo "Region:          ${{ steps.env.outputs.region }}"
          echo "Service Account: ${SERVICE_ACCOUNT}"
          echo "Image:           ${{ steps.env.outputs.registry }}/${{ inputs.service-name }}:${{ github.sha }}"
          echo "==========================================="
          
          gcloud run deploy ${{ inputs.service-name }} \
            --image ${{ steps.env.outputs.registry }}/${{ inputs.service-name }}:${{ github.sha }} \
            --region ${{ steps.env.outputs.region }} \
            --project ${{ steps.env.outputs.gcp_project }} \
            --platform managed \
            --service-account ${SERVICE_ACCOUNT} \
            --vpc-connector ${{ steps.env.outputs.vpc_connector }} \
            --vpc-egress private-ranges-only \
            --add-cloudsql-instances ${{ steps.env.outputs.cloudsql }} \
            --cpu ${{ inputs.cpu }} \
            --memory ${{ inputs.memory }} \
            --min-instances ${{ steps.env.outputs.min_instances }} \
            --max-instances ${{ inputs.max-instances }} \
            --timeout ${{ inputs.timeout }} \
            --concurrency ${{ inputs.concurrency-limit }} \
            --allow-unauthenticated \
            --set-env-vars "${ENV_VARS}" \
            --set-secrets "${SECRETS_FLAG}"

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ inputs.service-name }} \
            --region ${{ steps.env.outputs.region }} \
            --project ${{ steps.env.outputs.gcp_project }} \
            --format='value(status.url)')
          
          REVISION=$(gcloud run services describe ${{ inputs.service-name }} \
            --region ${{ steps.env.outputs.region }} \
            --project ${{ steps.env.outputs.gcp_project }} \
            --format='value(status.latestReadyRevisionName)')
          
          echo ""
          echo "==========================================="
          echo "Deployment Successful"
          echo "==========================================="
          echo "Service:     ${{ inputs.service-name }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Revision:    ${REVISION}"
          echo "URL:         ${SERVICE_URL}"
          echo "==========================================="
